# Engine

## General

エンジン部は画面描画・楽曲再生・IO管理を司るプログラム部分である。

原則、クライアント部について無知である。
つまり、エンジン部のコードにおいてクライアント部のモジュールを`use`している場合は不適切である。

しかし、機能的な分離が実現されているとは言えず、ある程度のリソース管理をクライアントに依頼している。

## Graphic

ウィンドウフレームワークとして[winit](https://crates.io/crates/winit)、レンダラとして[wgpu](https://crates.io/crates/wgpu)を用いている。
この技術選定は次に由る：

- Unity等の既存のゲームエンジンを使いたくないため
- クロスプラットフォームにしたいため
- かといってVulkanを扱うのは億劫であるため
- Rustを使いたいため

バックエンドはOSごとに次を選択している：

| OS | Backend |
| -- | ------- |
| Windows | Direct3D 12 |
| macOS | Metal |
| Linux | Vulkan |
| _otherwise_ | _default_ |

現状、2Dゲームを想定しているため、モデルは正方形のみである。
また、レンダリングパイプライン並びにシェーダも1種類のみである。
主な描画設定は次の通りである：

- 深度テストあり
- アルファブレンディングあり
- テクスチャ拡大時に最も近いテクセル値を参照
- テクスチャ縮小時に最も近いテクセル値を参照

半透明オブジェクトを正確に扱うため・またドローコール数を減らすために、クライアントは描画されるすべてのインスタンスのバッファデータ及びメタ情報を集め、`GraphicManager.render_with_metas()`を呼び、効率的に描画するようにせよ。
尚、このメソッドでは次の仕様に従ってインデクシングの範囲を計算している。

- 深度値が大きい順に描画される
- 深度値が異なるものはドローコールを分ける
- 同じテクスチャを用いるものをまとめてインデクシングする

文字を描画する際は描画前にテクスチャアトラスへラスタライズを行う。
このテクスチャアトラス上の文字画像は一行の高さが固定であり・一列の幅が自由であるような上優先左詰めの可変長二次元配列で管理されている。
文字がそれ以上右に描画できない場合、一行下の行に移る。
このとき、既にその行に文字画像が描画されている場合、それら文字画像は破棄されたとみなす。
既に破棄された文字画像を用いないために、クライアントは描画されるすべての文字情報を集め、`GraphicManager.load_all_character_images()`を呼び、必ずすべての文字画像がテクスチャアトラス上に存在するようにせよ。

## Input

ウィンドウフレームバッファとして[winit](https://crates.io/crates/winit)を用いている。

キーボード入力のみ管理する。

入力状態は各1キーに対してそのキーが何フレーム押されているかという整数値によって管理されている。
キーが押されたまさにそのフレームにおいて入力状態は`1`として記録される。
キーが押されていない場合は入力状態が無く、クライアントには`0`として伝わる。
キーアップの情報は棄却される。

## Resource

現状、resディレクトリ下にリソースを剝き出して配置することになっている。
将来的にはすべてのリソースを.datファイルにまとめ、ゲーム実行中常にオープンにして、必要時にシークして読み出すようにしたい。
